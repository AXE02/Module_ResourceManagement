@using Telerik.Web.Mvc.UI
@using BExIS.Web.Shell.Areas.RBM.Models.Booking;

@model List<BookingEventModel>


<p id="date_filter">
    <span id="date-label-from" class="date-label">From: </span><input class="date_range_filter date" type="text" id="datepicker_from" />
    <span id="date-label-to" class="date-label">To:<input class="date_range_filter date" type="text" id="datepicker_to" />
</p>

@if (ViewBag.history == "true")
{
    <div id="history_yes" class="history_list_booking">Show without history</div>
    <div id="history_no" style="display:none" class="history_list_booking">Show with history</div>
}
else
{
    <div id="history_yes" style="display:none" class="history_list_booking">Show without history</div>
    <div id="history_no" class="history_list_booking">Show with history</div>
}


<table id="booking_table" class="display" style="width:100%">
    <thead>
        <tr>
            <th title="Name">Name</th>
            <th title="Description">Description</th>
            <th title="Start date">Start date</th>
            <th title="End date">End date</th>
            <th title="Exploratory">Exploratory</th>
            <th title="Resource(s)">Resource(s)</th>

        </tr>
    </thead>
    <tbody>


        @foreach (var m in Model)
        {
            <tr>
                <td><a href="../../RBM/Schedule/Show/@m.Id">@m.Name</a></td>
                <td>@m.Description</td>
                <td>@m.startDate.ToString("dd.MM.yyyy")</td>
                <td>@m.endDate.ToString("dd.MM.yyyy")</td>
                <td>@m.ResourceAttributes</td>
                <td>@m.ResourceName</td>
            </tr>
        }
    </tbody>

</table>

<script type="text/javascript">

    $(document).ready(function () {

             $('.history_list_booking').on('click', function () {
            var history = false;
           console.log("click history");
            if ($("#history_yes").is(":visible")) {  
            }
            else {
                history = true; 
                
            }

            var myBooking = false;
            if ($('#MyBookings').is(':checked')) {
                myBooking = true;
            }

            var contentView = $('#contentView .active').find('input').val();


            if (contentView == "Events") {
                $.get('@Url.Action("GetEventsAsList", "Calendar", new RouteValueDictionary { { "area", "RBM"} })', { myBookings: myBooking, history: history }, function (data) {
                    $('#eventList').html(data);
                });
            }
            else { 
                $.get('@Url.Action("GetSchedulesAsList", "Calendar", new RouteValueDictionary { { "area", "RBM"} })', { myBookings: myBooking, history: history}, function (data) {
                $('#scheduleList').html(data);
            });
            }

        });    




jQuery.fn.dataTable.render.ellipsis = function ( cutoff, wordbreak, escapeHtml ) {
    var esc = function ( t ) {
        return t
            .replace( /&/g, '&amp;' )
            .replace( /</g, '&lt;' )
            .replace( />/g, '&gt;' )
            .replace( /"/g, '&quot;' );
    };

    return function ( d, type, row ) {
        // Order, search and type get the original data
        if ( type !== 'display' ) {
            return d;
        }

        if ( typeof d !== 'number' && typeof d !== 'string' ) {
            return d;
        }

        d = d.toString(); // cast numbers

        if ( d.length <= cutoff ) {
            return d;
        }

        var shortened = d.substr(0, cutoff-1);

        // Find the last white space character in the string
        if ( wordbreak ) {
            shortened = shortened.replace(/\s([^\s]*)$/, '');
        }

        // Protect against uncontrolled HTML input
        if ( escapeHtml ) {
            shortened = esc( shortened );
        }

        return '<span class="ellipsis" title="'+esc(d)+'">'+shortened+'&#8230;</span>';
    };
};

          var bookingTable = $("#booking_table").DataTable({
                "autoWidth": false,
                ordering: true,
                order: [[ 2, "asc" ]], // order by startDate
                paging: false,
                responsive: true,
                "columns": [
                    { "width": "30%" },
                    { "width": "40%" },
                    null,
                    null,
                    null,
                    null

                ],
    columnDefs: [
     {
      targets: 1,
      render: $.fn.dataTable.render.ellipsis( 60, true )
    }]
            });

      
        $("#datepicker_from").datepicker({
            showOn: "button",
            buttonText: "<i class='fa fa-calendar'></i>",
            "onSelect": function (date) {
                minDateFilter = new Date(date).getTime();
                bookingTable.draw();
            }
        }).keyup(function () {
            minDateFilter = new Date(this.value).getTime();
            bookingTable.draw();
        }).next('button').button({
            icons: {
                primary: 'ui-icon-calendar'
            }, text: false
        });

        $("#datepicker_to").datepicker({
            showOn: "button",
            buttonText: "<i class='fa fa-calendar'></i>",
            "onSelect": function (date) {
                maxDateFilter = new Date(date).getTime();
                bookingTable.draw();
            }
        }).keyup(function () {
            maxDateFilter = new Date(this.value).getTime();
            bookingTable.draw();
        });

    });

    // Date range filter
    minDateFilter = "";
    maxDateFilter = "";

    $.fn.dataTableExt.afnFiltering.push(
        function (oSettings, aData, iDataIndex) {

            if (typeof aData._date == 'undefined') {
                aData._date = moment(aData[2], "DD.MM.YYYY").toDate().getTime();
            }
            if (minDateFilter && !isNaN(minDateFilter)) {
                if (aData._date < minDateFilter) {
                    return false;
                }
            }

            if (maxDateFilter && !isNaN(maxDateFilter)) {
                if (aData._date > maxDateFilter) {
                    return false;
                }
            }

            return true;
        }
    );


</script>
<style>
    .ui-datepicker-trigger {
        border: none;
        background: none;
        color: black;
    }
</style>